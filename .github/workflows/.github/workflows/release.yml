name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build:
    name: Build Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel build twine
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Lint code
        run: |
          flake8 src/ tests/ --max-line-length=100 --exit-zero
          black --check src/ tests/ --exit-zero
          isort --check-only src/ tests/ --exit-zero
        continue-on-error: true

      - name: Run tests
        run: |
          pytest tests/ \
            -v \
            --cov=src \
            --cov-report=xml \
            --cov-fail-under=80 \
            --tb=short

      - name: Build distribution packages
        run: |
          python -m build

      - name: Check distribution packages
        run: |
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: distribution-packages
          path: dist/
          retention-days: 7

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù…Ù† tag
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Ù‚Ø±Ø§Ø¡Ø© CHANGELOG
          if [ -f "CHANGELOG.md" ]; then
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚Ø³Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1 > changelog_section.md
            cat changelog_section.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          body_path: changelog_section.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    
    environment:
      name: pypi
      url: https://pypi.org/project/manga-ai-translator/
    
    permissions:
      id-token: write
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: distribution-packages
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verify-metadata: true
          skip-existing: false

  publish-test-pypi:
    name: Publish to Test PyPI
    runs-on: ubuntu-latest
    needs: build
    
    environment:
      name: testpypi
      url: https://test.pypi.org/project/manga-ai-translator/
    
    permissions:
      id-token: write
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: distribution-packages
          path: dist/

      - name: Publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist/
          skip-existing: true
        continue-on-error: true

  build-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    
    permissions:
      packages: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_version=${VERSION%.*}" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          target: production
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            manga-ai-translator:${{ steps.version.outputs.version }}
            manga-ai-translator:${{ steps.version.outputs.short_version }}
            manga-ai-translator:latest
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.short_version }}
            ghcr.io/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}

  update-changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    needs: [create-release, publish-pypi]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          # Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù
          {
            echo "# Changelog"
            echo ""
            echo "## [${{ steps.version.outputs.version }}] - $(date -u +'%Y-%m-%d')"
            echo ""
            echo "### Added"
            echo "- New features"
            echo ""
            echo "### Changed"
            echo "- Improvements"
            echo ""
            echo "### Fixed"
            echo "- Bug fixes"
            echo ""
            echo "---"
            echo ""
            tail -n +2 CHANGELOG.md
          } > CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "chore: update changelog for release ${{ steps.version.outputs.version }}"
        continue-on-error: true

      - name: Push changes
        run: |
          git push origin main
        continue-on-error: true

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [create-release, publish-pypi]
    if: always()
    
    steps:
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "ðŸš€ Release Published",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Manga AI Translator Release*\n\n*Version:* ${{ steps.version.outputs.version }}\n*Status:* âœ… Success\n*PyPI:* https://pypi.org/project/manga-ai-translator/\n*GitHub:* https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
                  }
                }
              ]
            }
        continue-on-error: true

  create-discussion:
    name: Create Release Discussion
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Discussion
        uses: abiramen/gh-action-create-discussion@v1
        with:
          title: "Release: ${{ github.ref_name }}"
          body: |
            ## ðŸŽ‰ New Release Available!
            
            Version **${{ github.ref_name }}** has been released!
            
            ðŸ“¦ [PyPI Package](https://pypi.org/project/manga-ai-translator/)
            ðŸ“š
î€€
